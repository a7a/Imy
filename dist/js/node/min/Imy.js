!function(t,n){"use strict";var e=require("./lib/stringToFragments.js").stringToFragments,r=require("./ImyDBRdbms.js").ImyDBRdbms,o=require("./ImyDBIndexedDB.js").ImyDBIndexedDB,i=require("./param/Error.js").ERROR,a=require("./lib/SyncPromise.js").SyncPromise,c=require("./lib/asyncLoop").asyncLoop,s=require("./conf/conf.json"),u=require("./conf/database.json"),f=function(){this.db=null,this._lang=s.default_lang||"ja",this._driver=s.driver,this._dbconf=u[this._driver],this._conf=null};f._name_="Imy",f.prototype.initialize=function(){var t=i.config_error(this.constructor._name_,"initialize");if(!s[this._lang])throw t("conf.json not supported lang '"+this._lang+".");if(this._conf||(this._conf=s[this._lang]),!this._conf.skip)throw t("conf.json has no 'skip' parameter for lang '"+this._lang+"'.");if(!Array.isArray(this._conf.omit))throw t("'omit' parameter (of conf.json) must be Array.");if(!this._dbconf)throw new Error;if("mysql"===this._driver||"pg"===this._driver||"sqlite3"===this._driver)this.db=new r(this._conf);else{if("idb"!==this._driver)throw new Error;this.db=new o(this._conf)}this.db.useConfig(this._dbconf)},f.prototype._isInitialize=function(){var t=this;return new a(function(n,e){t.db?n():e(new Error("Imy is not initialize"))})},f.prototype.open=function(){var t=this;return this._isInitialize().then(function(){return t.db.open()})},f.prototype.close=function(){return this.db.close()},f.prototype.useLang=function(t){this.lang=t},f.prototype.useDatabaseConfig=function(t,n){t&&(this._driver=t),this._dbconf=n},f.prototype.useConfig=function(t){this._conf=t},f.prototype._createFragment=function(t,n){for(var r=e(t,n),o=[],i=0;i<r.length;i+=1)for(var a=r[i],c=a.skip,s=a.frags,u=0;u<s.length;u+=1){var f=o.length;o[f]={},o[f].skip=c,o[f].frag=s[u][0].frag+s[u][1].frag,o[f].pos1=s[u][0].pos,o[f].pos2=s[u][1].pos,o[f].sort_flag=a.sort_flags[u]}return o},f.prototype.save=function(t,n){var e=this,r=this.db,o=null;return new a(function(a,s){r.transaction(function(){r.getDataForTypeAndContent(t,n).then(function(a){if(null===a||0===a.length){var s=e._createFragment(n,e._conf);r.addDatum(t,n).then(function(n){c(s,function(e,i){var a=0;r.getIndexFragmentIdForTypeAndValue(t,e.frag).then(function(n){return null==n||0===n.length?r.addIndexFragment(t,e.frag).then(function(t){a=t}):void(a=n)}).then(function(){return r.addIndexParameter(t,a,n,e.pos1,e.pos2,e.sort_flag,e.skip)}).then(i)["catch"](function(t){o=t,r.rollback()})}).then(function(){r.commit()})["catch"](function(t){o=t,r.rollback()})})["catch"](function(t){console.error(t)})}else o=i.data_duplicate(t,n),r.rollback()})}).then(a)["catch"](function(t){s(t||o)})})},f.prototype.update=function(t,n){var e=this,r=this.db,o=null;return new a(function(a,s){r.transaction(function(){r.getDataForTypeAndContent(t.type,t.content).then(function(a){if(null!==a&&0!==a.length){var s=a[0].id,u=e._createFragment(t.content,e._conf),f=e._createFragment(n.content,e._conf);c(u,function(n,e){r.countIndexParametersOfFragment(t.type,n.frag).then(function(t){if(1===t)return r.removeIndexFragments(u.type,n.frag)}).then(e)["catch"](function(t){o=t,r.rollback()})}).then(function(){return r.removeIndexParameters(s)}).then(function(){return c(f,function(t,e){var i=0;r.getIndexFragmentIdForTypeAndValue(n.type,t.frag).then(function(e){return null==e||0===e.length?r.addIndexFragment(n.type,t.frag).then(function(t){i=t}):void(i=e)}).then(function(){return r.addIndexParameter(n.type,i,s,t.pos1,t.pos2,t.sort_flag,t.skip)}).then(e)["catch"](function(t){o=t,r.rollback()})})}).then(function(){return r.updateData({type:n.type,content:n.content},{id:s})}).then(function(){r.commit()})["catch"](function(t){o=t,r.rollback()})}else o=i.not_registry_data(t.type,t.content),r.rollback()})}).then(a)["catch"](function(t){s(t||o)})})},f.prototype.remove=function(t,n){var e=this,r=this.db,o=null;return new a(function(a,s){r.transaction(function(){r.getDataForTypeAndContent(t,n).then(function(a){if(null!==a&&0!==a.length){var s=a[0].id,u=e._createFragment(n,e._conf);c(u,function(n,e){r.countIndexParametersOfFragment(t,n.frag).then(function(e){if(1===e)return r.removeIndexFragments(t,n.frag)}).then(e)["catch"](function(t){o=t,r.rollback()})}).then(function(){return r.removeIndexParameters(s)}).then(function(){return r.removeData(s)}).then(function(){r.commit()})["catch"](function(t){o=t,r.rollback()})}else o=i.not_registry_data(t,n),r.rollback()})}).then(a)["catch"](function(t){s(t||o)})})},f.prototype.search=function(t,n){var e=this,r=this.db;return new a(function(o,i){var a=[];r.search(t,n,e._conf).then(function(t){c(t,function(t,n){r.getDatumForId(t.id).then(function(e){a[a.length]={data_id:t.id,start_pos:t.start_pos,end_pos:t.end_pos,weight:t.weight,sort_num:t.sort_num,type:e[0].type,content:e[0].content,created_at:e[0].created_at,updated_at:e[0].updated_at},n()})["catch"](i)}).then(function(){o(a)})["catch"](i)})["catch"](function(t){console.log(t)})})},f.prototype.truncate=function(){var t=this.db;return new a(function(n,e){t.truncateIndexFragments().then(function(){return t.truncateIndexParameters()}).then(function(){return t.truncateData()}).then(n)["catch"](e)})},t.Imy=f,n.Imy=f}(this,(0,eval)("this"));