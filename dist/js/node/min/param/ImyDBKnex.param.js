!function(e){"use strict";var t=require("../lib/util.js").util,n={idx:{name:"imy_indices",all_columns:["type","value","data_id","content_pos1","content_pos2","sort_flag","skip"],create:null,drop:null,index:[],select:{},insert:null,update:{},"delete":{}},fr:{name:"imy_idx_fragments",all_columns:["type","value"],create:null,drop:null,index:[],select:{},insert:null,update:{},"delete":{}},pa:{name:"imy_idx_parameters",all_columns:["type","idx_fragment_id","skip","data_id","content_pos1","content_pos2","sort_flag"],create:null,drop:null,index:[],select:{},insert:null,update:{},"delete":{}},da:{name:"imy_data",all_columns:["id","type","content","created_at","updated_at"],create:null,drop:null,index:[],select:{},insert:null,update:{},"delete":{}}};n.search={"index.for_type_values":function(e,a){if(t.hasProperty(a,["type","values"]))return e.select("type","data_id","value","content_pos1 as d_content_pos1","content_pos2 as d_content_pos2","sort_flag").from(n.idx.name).where("type","=",a.type).andWhereIn("value",a.value).groupBy(["group","type","data_id","value","content_pos1","content_pos2"]).orderBy(["group","type","data_id","content_pos1","content_pos2","value"])},"parametered_fragment.for_type_values":function(e,a){if(t.hasProperty(a,["type","values"]))return e.select("p.type as type","p.data_id as data_id","f.value as value","p.content_pos1 as d_content_pos1","p.content_pos2 as d_content_pos2","p.sort_flag as sort_flag").from(n.fr.name+" as f").innerJoin(n.pa.name+" as p",function(){this.on("f.type","=","p.type").on("f.id","=","p.idx_fragment_id")}).where("f.type","=",a.type).whereIn("f.value",a.values).groupBy(["p.type","p.data_id","f.value","p.content_pos1","p.content_pos2"]).orderBy(["p.type","p.data_id","p.content_pos1","p.content_pos2","f.value"])}},n.count={"index.for_type_value":function(e,a){if(t.hasProperty(a,["type","value"]))return e.count().from(n.idx.name).where("type","=",a.type).andWhere("value","=",a.value)},"parametered_fragment.for_type_value":function(e,a){if(t.hasProperty(a,["type","value"]))return e.count().from(n.fr.name+" as f").innerJoin(n.pa.name+" as p",function(){this.on("f.type","=","p.type").on("f.id","=","p.idx_fragment_id")}).where("f.type","=",a.type).andWhere("f.value","=",a.value)}},n.idx.create=function(e){return e.schema.createTable(this.name,function(n){n.increments(),n.string("type",100),n.string("value",2),n.biginteger("data_id"),n.integer("content_pos1"),n.integer("content_pos2"),n.integer("sort_flag"),n.integer("skip"),t.isMysql(e)&&n.engine("InnoDB")})},n.idx.drop=function(e){return e.schema.dropTable(this.name)},n.idx.index=[{columns:["type","value","skip","data_id","content_pos1","content_pos2"],name:"imy_index_idx1",create:function(e){var t=this;return e.schema.table(n.idx.name,function(e){e.index(t.columns,t.name)})},drop:function(e){var t=this;return e.schema.table(n.idx.name,function(e){e.dropIndex(t.columns,t.name)})}}],n.idx.select={},n.idx.insert=function(e,n){if(t.hasProperty(n,[this.all_columns])){var a={type:n.type,value:n.value,data_id:n.data_id,content_pos1:n.content_pos1,content_pos2:n.content_pos2,skip:n.skip};return e.insert(a).into(this.name)}},n.idx["delete"]={all:function(e){return e.from(this.name).del()}.bind(n.idx),for_dataid:function(e,n){if(t.hasProperty(n,["data_id"]))return e.from(this.name).where("data_id","=",n.data_id).del()}.bind(n.idx)},n.fr.create=function(e){return e.schema.createTable(this.name,function(n){n.increments(),n.string("type",100),n.string("value",2),n.unique(["type","value"]),t.isMysql(e)&&n.engine("InnoDB")})},n.fr.drop=function(e){return e.schema.dropTable(this.name)},n.fr.select={all:function(e){return e.select(this.all_columns.concat("id")).from(this.name)}.bind(n.fr),"id.for_type_value":function(e,n){if(t.hasProperty(n,["type","value"]))return e.select("id").from(this.name).where("type","=",n.type).andWhere("value","=",n.value)}.bind(n.fr)},n.fr.insert=function(e,n){if(t.hasProperty(n,this.all_columns)){var a={type:n.type,value:n.value};return e.insert(a).into(this.name)}},n.fr["delete"]={all:function(e){return e.from(this.name).del()}.bind(n.fr),for_type_value:function(e,n){if(t.hasProperty(n,["type","value"]))return e.from(this.name).where("type","=",n.type).andWhere("value","=",n.value).del()}.bind(n.fr)},n.pa.create=function(e){return e.schema.createTable(this.name,function(n){n.increments(),n.biginteger("idx_fragment_id"),n.string("type",100),n.biginteger("data_id"),n.integer("content_pos1"),n.integer("content_pos2"),n.integer("sort_flag"),n.integer("skip"),t.isMysql(e)&&n.engine("InnoDB")})},n.pa.drop=function(e){return e.schema.dropTable(this.name)},n.pa.index=[{name:"imy_idx_parameter_idx1",columns:["type","idx_fragment_id","skip","data_id","content_pos1","content_pos2"],create:function(e){var t=this;return e.schema.table(n.pa.name,function(e){e.index(t.columns,t.name)})},drop:function(e){var t=this;return e.schema.table(n.pa.name,function(e){e.dropIndex(t.columns,t.name)})}}],n.pa.select={all:function(e){return e.select(this.all_columns).from(this.name)}.bind(n.pa)},n.pa.insert=function(e,n){if(t.hasProperty(n,this.all_columns)){var a={type:n.type,idx_fragment_id:n.idx_fragment_id,data_id:n.data_id,content_pos1:n.content_pos1,content_pos2:n.content_pos2,sort_flag:n.sort_flag,skip:n.skip};return e.insert(a).into(this.name)}},n.pa["delete"]={all:function(e){return e.from(this.name).del()}.bind(n.pa),for_dataid:function(e,n){if(t.hasProperty(n,["data_id"]))return e.from(this.name).where("data_id","=",n.data_id).del()}.bind(n.pa)},n.da.create=function(e){return e.schema.createTable(this.name,function(n){n.increments(),n.string("type",100).notNullable(),n.text("content"),n.timestamp("created_at").defaultTo(e.fn.now()),n.timestamp("updated_at"),t.isMysql(e)&&n.engine("InnoDB")})},n.da.drop=function(e){return e.schema.dropTable(this.name)},n.da.index=[{columns:["type",{content:255}],name:"imy_data_idx1",create:function(e){var a=this,r=[],i=null,o=0,s=0,d="";if(t.isMysql(e)){for(o=0,s=a.columns.length;o<s;o+=1)i=a.columns[o],"string"==typeof i?r[r.length]="`"+i+"`":(d=Object.keys(i)[0],r[r.length]="`"+d+"`("+i[d]+")");return e.raw("alter table `"+n.da.name+"` add index "+a.name+"("+r.join(",")+")")}for(o=0,s=a.columns.length;o<s;o+=1)i=a.columns[o],"string"==typeof i?r[r.length]=i:(d=Object.keys(i)[0],r[r.length]=d);return e.schema.table(n.da.name,function(e){e.index(r,a.name)})},drop:function(e){var t=this;return e.schema.table(n.da.name,function(e){e.dropIndex(t.columns,t.name)})}}],n.da.select={"all.for":function(e,n){var a=e.select(this.all_columns).from(this.name);return t.hasProperty(n,["id"])&&a.where("id","=",n.id),t.hasProperty(n,["type"])&&a.where("type","=",n.type),t.hasProperty(n,["content"])&&a.where("content","=",n.content),a}.bind(n.da)},n.da.insert=function(e,n){if(t.hasProperty(n,["type","content"])){var a={type:n.type,content:n.content};return e.insert(a).into(this.name)}},n.da.update={"for":function(e,n,a){var r={};t.hasProperty(n,["content"])&&(r.content=n.content),t.hasProperty(n,["type"])&&(r.type=n.type),r.updated_at=t._date(e,new Date);var i=e.from(this.name).update(r);return t.hasProperty(a,["id"])&&i.where("id","=",a.id),t.hasProperty(a,["type"])&&i.where("type","=",a.type),t.hasProperty(a,["content"])&&i.where("content","=",a.content),i}.bind(n.da)},n.da["delete"]={all:function(e){return e.from(this.name).del()}.bind(n.da),"for":function(e,n){if(t.hasProperty(n,["id"])){var a=e.from(this.name).where("id","=",n.id);return a.del()}}.bind(n.da)},e.ImyDBKnex=n}(this);