!function(t){"use strict";var n=require("./calcFragmentNum.js").calcFragmentNum,i=[],e={},r=0,a=-1,o=-1,_=function(t,n,_,d,f){var u=[],v=null,E=[];if(i=[],e={},r=0,a=-1,o=-1,0===t.length)return u;for(e=l(E,t),a=e.start,r=e.data_id;;)if(o===-1&&g(E)>=_*f.matching_min_ratio&&g(E)<_*f.matching_max_ratio)if(v=m(E,d,_,f),u=p(u,v),1===v.weight){if(h(E,t,_,f),o===-1){if(0===E.length)break;c(E)}}else o=e.start,e=l(E,t);else if(g(E)>_*f.matching_max_ratio||0===t.length&&0===i.length||e.data_id!==r){if(g(E)>_*f.matching_max_ratio){if(e=s(E),h(E,t,_,f),o===-1){if(0===E.length)break;c(E)}}else if(o===-1){if(0===t.length)break;c(E)}else if(0===t.length&&0===i.length&&(v=m(E,d,_,f),u=p(u,v)),E.length>2&&(e=s(E)),h(E,t,_,f),o===-1){if(0===E.length)break;c(E)}}else o!==-1&&g(E)<=_*f.matching_max_ratio?(v=m(E,d,_,f),u=p(u,v),1===v.weight?h(E,t,_,f):e=l(E,t)):e=l(E,t);return u},l=function(t,n){var e={data_id:0,start:0,items:[]};if(i.length>0)e=i.pop();else{if(!(n.length>0))return null;for(;n.length>0&&(0===e.data_id||n[0].data_id===e.data_id&&n[0].d_content_pos1===e.start);)e.data_id=n[0].data_id,e.start=n[0].d_content_pos1,e.items[e.items.length]=n.shift()}return 0===e.data_id?null:(t[t.length]=e,e)},s=function(t){return i[i.length]=t.pop(),f(t)},d=function(t){return t[0]},f=function(t){return t[t.length-1]},u=function(t){return t.splice(0,t.length-1),f(t)},g=function(t){return 0===t.length?0:t[t.length-1].start-t[0].start+2},h=function(t,n,i,_){if(t.shift(),t.length<2){if(e=l(t,n),null===e||e.data_id!==r)return void(o=-1);r=e.data_id}if(a=d(t).start,g(t)>=i*_.matching_min_ratio){for(;g(t)>i*_.matching_min_ratio;)if(e=s(t),o=e.start,a===o)return void(o=-1)}else{for(;g(t)<i*_.matching_min_ratio;){if(e=l(t,n),null===e)return void(o=-1);if(e.data_id!==r)return a=o,o=-1,void(r=e.data_id);if(0===n.length)return void(o=g(t)>=i*_.matching_min_ratio?e.start:-1)}o=e.start}},c=function(t){e=u(t),a=e.start,o=-1,r=e.data_id},m=function(t,i,e,r){var a=d(t).data_id,o=Number.MAX_SAFE_INTEGER,_=0,l=Number.MAX_SAFE_INTEGER,s=0,f=Number.MAX_SAFE_INTEGER,u=0,g=0,h=0,c=0,m=0,p=0,v={},E=!0,N=0,b=0,k=0,A=0;for(N=0,b=t.length;N<b;N+=1){var w=t[N].items;for(k=0,A=w.length;k<A;k+=1){var F=w[k],x=F.value;void 0===v[x]?v[x]=0:v[x]=v[x]+1,void 0!==i[x][v[x]]?(c=v[x],E=!0):(c=i[x].length-1,E=!1),g=i[x][c].pos1,h=i[x][c].pos2,m+=1,o>F.d_content_pos1&&(o=F.d_content_pos1,E&&(l=F.d_content_pos1)),_<F.d_content_pos2&&(_=F.d_content_pos2,E&&(s=F.d_content_pos2)),f>g&&(f=g),u<h&&(u=h),p+=F.sort_flag^i[x][c].sort_flag}}var S=_-o-(u-f),G=0;for(G=S>0?m/n(r.skip,e+S):m/n(r.skip,e);G>1;)G-=1;return r.limit_min_score&&G<r.limit_min_score?null:{id:a,start_pos:l,end_pos:s,weight:G,sort_num:p}},p=function(t,n){if(!n)return t;for(var i=0,e=t.length;i<e;i+=1)if(t[i].id===n.id&&t[i].start_pos===n.start_pos)return t[i].weight<n.weight&&(t[i]=n),t;return t[t.length]=n,t};t.calculateScore=_}(this);